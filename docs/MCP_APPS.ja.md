# MCP Apps UI ガイド

> **バージョン:** 0.10.63+  
> **機能:** MCP Apps Extension (Phase 6)  
> **日付:** 2026-02-08

このガイドでは、MCP Apps を通じた proofscan のインタラクティブUI機能の使い方を説明します。

---

## 目次

1. [概要](#概要)
2. [前提条件](#前提条件)
3. [利用可能なUI](#利用可能なui)
4. [使い方](#使い方)
5. [セキュリティモデル](#セキュリティモデル)
6. [トラブルシューティング](#トラブルシューティング)

---

## 概要

MCP Apps は Model Context Protocol の拡張仕様（SEP-1865）で、MCP サーバーが Claude Desktop などのホストアプリケーション内でインタラクティブなUIを提供できるようにします。

proofscan は MCP Apps を活用して以下を提供します：
- **プロトコルトレースビューア** — MCP/A2A イベントをタイムラインで可視化
- **リアルタイム更新** — 通知を通じてイベントをライブで監視
- **ページネーション** — 大量のイベント履歴をブラウズ

### 仕組み

```
┌────────────────────────────────────────┐
│ Claude Desktop (Host)                  │
│  ┌──────────────────────────────────┐  │
│  │ サンドボックス iframe            │  │
│  │  ┌────────────────────────────┐  │  │
│  │  │ proofscan トレースビューア │  │  │
│  │  │  - イベントタイムライン    │  │  │
│  │  │  - ページネーション        │  │  │
│  │  │  - リアルタイム更新        │  │  │
│  │  └────────────────────────────┘  │  │
│  └──────────────────────────────────┘  │
│            ↕ postMessage               │
│  ┌──────────────────────────────────┐  │
│  │ MCP Client                       │  │
│  └──────────────────────────────────┘  │
└────────────────────────────────────────┘
              ↕ MCP JSON-RPC
┌────────────────────────────────────────┐
│ proofscan MCP Server                   │
│  - UI Resources (trace-viewer)         │
│  - Tools (proofscan_getEvents)         │
│  - EventLineDB                         │
└────────────────────────────────────────┘
```

---

## 前提条件

- **proofscan** 0.10.63 以上
- **Claude Desktop** MCP Apps 対応版（2025-11-21 プロトコルバージョン）
- イベントをキャプチャ中のアクティブなプロキシセッション

```bash
# バージョン確認
pfscan --version
# 出力: 0.10.63 以上であること
```

---

## 利用可能なUI

### トレースビューア

**リソースURI:** `ui://proofscan/trace-viewer`

プロトコルイベント（リクエスト、レスポンス、通知）のインタラクティブなタイムライン。

**機能:**
- 色分けされたイベントカード（リクエスト vs レスポンス）
- タイムスタンプと所要時間の表示
- 展開可能なJSONペイロード
- 上スクロールで履歴読み込み（ページネーション）
- 通知によるリアルタイム更新

---

## 使い方

### ステップ 1: プロキシを起動

まず、イベントをキャプチャするためにプロキシモードで proofscan を起動します：

```bash
# MCPサーバーと共にプロキシを起動
pfscan proxy start

# またはコネクタを追加してスキャン
pfscan connector add my-server --command "npx my-mcp-server"
pfscan scan start --id my-server
```

### ステップ 2: Claude Desktop を設定

Claude Desktop の設定（`claude_desktop_config.json`）に proofscan を追加します：

```json
{
  "mcpServers": {
    "proofscan": {
      "command": "npx",
      "args": ["proofscan", "server"]
    }
  }
}
```

保存後、Claude Desktop を再起動してください。

### ステップ 3: トレースビューアを使用

Claude Desktop で、Claude にプロトコルイベントの表示を依頼します：

> 「最近のプロトコルイベントを表示して」

Claude は `proofscan_getEvents` ツールを呼び出し、以下が行われます：
1. 会話用のテキストサマリを返却
2. パネルにトレースビューアUIを開く
3. 詳細なイベントを表示

### ステップ 4: UIを操作

- **上にスクロール** — 古いイベントを読み込み（ページネーション）
- **イベントをクリック** — 展開してJSONペイロード全体を表示
- **リアルタイム監視** — 新しいイベントが自動的に表示

---

## セキュリティモデル

proofscan は MCP Apps 向けに堅牢なセキュリティモデルを実装しています：

### トークン分離

- セッショントークンは postMessage 通信の認証に使用
- トークンは **MCP サーバーに送信されない**（ホスト層でストリップ）
- 監査目的でのみログに記録（BridgeEnvelope パターン）

### 相関ID

すべてのUI操作は4種類の相関IDで追跡可能：

| ID | 目的 |
|----|------|
| `ui_session_id` | UIセッション（iframe インスタンスごとに1つ） |
| `ui_rpc_id` | UIからのRPC呼び出し |
| `correlation_id` | 論理的な操作ID |
| `tool_call_fingerprint` | ツール呼び出しパラメータのハッシュ |

### コンテンツセキュリティ

- UI は **サンドボックス化された iframe** で実行（opaque origin）
- CSP がスクリプトとスタイルのソースを制限
- HTMLエスケープでXSSを防止

---

## トラブルシューティング

### UIが表示されない

1. **proofscan バージョンを確認** — 0.10.63 以上が必要
2. **Claude Desktop バージョンを確認** — MCP Apps 対応版（2025-11-21+）が必要
3. **サーバーが起動しているか確認** — `pfscan server` がアクティブであること

### イベントが表示されない

1. **アクティブなセッションを確認** — `pfscan session ls` でセッションを確認
2. **プロキシがキャプチャしているか確認** — `pfscan events ls` にイベントが表示されるべき
3. **sessionId を確認** — トレースビューアはデフォルトで `test-session` IDを使用

### リアルタイム更新されない

1. **通知サポートを確認** — ホストがMCP通知をサポートしている必要がある
2. **接続状態を確認** — UIヘッダーのステータスインジケーターを確認

### 「イベントの読み込みに失敗」エラー

1. **データベースを確認** — proofscan データベースにアクセス可能か確認
2. **権限を確認** — データディレクトリへの読み取り権限を確認

---

## 関連ドキュメント

- **[プロキシガイド](PROXY.ja.md)** — MCP プロキシの設定
- **[シェルモード](SHELL.ja.md)** — イベント探索のインタラクティブシェル
- **[API リファレンス](API.md)** — イベントへのプログラマティックアクセス

---

## 付録: ツールリファレンス

### proofscan_getEvents

ページネーション対応でプロトコルイベントを取得します。

**入力スキーマ:**
```json
{
  "sessionId": "string (必須)",
  "limit": "number (デフォルト: 50)",
  "before": "string (ページネーション用イベントID)"
}
```

**出力:**
- `content` — 会話用のテキストサマリ
- `structuredContent` — UI用の完全なイベントデータ
- `_meta.cursors` — ページネーションカーソル

**例:**
```json
{
  "content": [
    { "type": "text", "text": "50件のイベントが見つかりました..." }
  ],
  "structuredContent": {
    "events": [...],
    "_meta": {
      "cursors": { "before": "evt_123", "after": "evt_173" }
    }
  }
}
```
